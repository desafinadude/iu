<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiragana Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .settings-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            text-align: center;
            margin-bottom: 15px;
            padding-right: 60px;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 12px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        .question-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .question-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
        }

        .sound-display {
            font-size: 72px;
            font-weight: bold;
            color: #667eea;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .sound-display:hover {
            transform: scale(1.05);
        }

        .sound-display:active {
            transform: scale(0.95);
        }

        .sound-display.hiragana {
            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
        }

        .sound-display.romaji {
            text-transform: uppercase;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .option-btn {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 30px 20px;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-btn.hiragana {
            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
        }

        .option-btn.romaji {
            text-transform: uppercase;
        }

        .option-btn:hover {
            transform: scale(1.05);
            border-color: #667eea;
            background: #f8f9ff;
        }

        .option-btn:active {
            transform: scale(0.95);
        }

        .option-btn.correct {
            background: #4caf50;
            border-color: #4caf50;
            color: white;
            animation: correctPulse 0.5s ease;
        }

        .option-btn.wrong {
            background: #f44336;
            border-color: #f44336;
            color: white;
            animation: wrongShake 0.5s ease;
        }

        .option-btn.disabled {
            pointer-events: none;
            opacity: 0.6;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .next-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 18px 40px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.2s ease;
            display: none;
        }

        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .next-btn:active {
            transform: translateY(0);
        }

        .next-btn.show {
            display: block;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .feedback.wrong {
            background: #ffebee;
            color: #c62828;
        }

        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f0f0f0;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .hiragana-grid {
            margin-top: 15px;
        }

        .chart-section {
            margin-bottom: 25px;
        }

        .chart-section h4 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .chart-table {
            display: grid;
            grid-template-columns: auto repeat(10, 1fr);
            gap: 4px;
            margin-bottom: 20px;
        }

        .chart-header {
            background: #f8f9ff;
            padding: 8px 4px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #999;
            border-radius: 6px;
        }

        .vowel-label {
            background: #f8f9ff;
            padding: 8px 4px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #999;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .char-toggle {
            aspect-ratio: 1;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .char-toggle:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .char-toggle.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .char-toggle.inactive {
            background: #f5f5f5;
            opacity: 0.5;
        }

        .char-toggle.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .char-toggle.empty:hover {
            transform: none;
        }

        .toggle-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: #764ba2;
        }

        @media (max-width: 480px) {
            .sound-display {
                font-size: 56px;
            }

            .option-btn {
                font-size: 40px;
                padding: 25px 15px;
            }

            h1 {
                font-size: 24px;
            }

            .char-toggle {
                font-size: 20px;
            }

            .chart-header, .vowel-label {
                font-size: 12px;
                padding: 6px 2px;
            }

            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
            <h1>üáØüáµ Hiragana Practice</h1>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="stats">
                <span id="scoreText">Score: 0/0</span>
                <span id="streakText">Streak: 0</span>
            </div>
        </div>

        <div class="question-card">
            <div class="question-text" id="questionText">Select the character for:</div>
            <div class="sound-display romaji" id="soundDisplay" title="Click to hear pronunciation">ka</div>

            <div class="options-grid" id="optionsGrid">
                <!-- Options will be generated by JavaScript -->
            </div>

            <div class="feedback" id="feedback"></div>
            <button class="next-btn" id="nextBtn">Next Question</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn" id="closeModal">√ó</button>
            </div>

            <div class="settings-section">
                <h3>Mode</h3>
                <div class="mode-toggle">
                    <button class="mode-btn active" id="normalModeBtn">
                        Normal Mode<br>
                        <small>Sound ‚Üí Character</small>
                    </button>
                    <button class="mode-btn" id="reverseModeBtn">
                        Reverse Mode<br>
                        <small>Character ‚Üí Sound</small>
                    </button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Characters to Practice</h3>
                <div class="toggle-controls">
                    <button class="control-btn" id="selectAllBtn">Select All</button>
                    <button class="control-btn" id="deselectAllBtn">Deselect All</button>
                    <button class="control-btn" id="basicsOnlyBtn">Basics Only</button>
                </div>
                <div class="hiragana-grid" id="hiraganaGrid">
                    <!-- Character toggles will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Complete Hiragana character set with categories
        const hiraganaData = [
            // Vowels (basics)
            { char: '„ÅÇ', romaji: 'a', basic: true },
            { char: '„ÅÑ', romaji: 'i', basic: true },
            { char: '„ÅÜ', romaji: 'u', basic: true },
            { char: '„Åà', romaji: 'e', basic: true },
            { char: '„Åä', romaji: 'o', basic: true },

            // K-row (basics)
            { char: '„Åã', romaji: 'ka', basic: true },
            { char: '„Åç', romaji: 'ki', basic: true },
            { char: '„Åè', romaji: 'ku', basic: true },
            { char: '„Åë', romaji: 'ke', basic: true },
            { char: '„Åì', romaji: 'ko', basic: true },

            // S-row (basics)
            { char: '„Åï', romaji: 'sa', basic: true },
            { char: '„Åó', romaji: 'shi', basic: true },
            { char: '„Åô', romaji: 'su', basic: true },
            { char: '„Åõ', romaji: 'se', basic: true },
            { char: '„Åù', romaji: 'so', basic: true },

            // T-row (basics)
            { char: '„Åü', romaji: 'ta', basic: true },
            { char: '„Å°', romaji: 'chi', basic: true },
            { char: '„Å§', romaji: 'tsu', basic: true },
            { char: '„Å¶', romaji: 'te', basic: true },
            { char: '„Å®', romaji: 'to', basic: true },

            // N-row (basics)
            { char: '„Å™', romaji: 'na', basic: true },
            { char: '„Å´', romaji: 'ni', basic: true },
            { char: '„Å¨', romaji: 'nu', basic: true },
            { char: '„Å≠', romaji: 'ne', basic: true },
            { char: '„ÅÆ', romaji: 'no', basic: true },

            // H-row (basics)
            { char: '„ÅØ', romaji: 'ha', basic: true },
            { char: '„Å≤', romaji: 'hi', basic: true },
            { char: '„Åµ', romaji: 'fu', basic: true },
            { char: '„Å∏', romaji: 'he', basic: true },
            { char: '„Åª', romaji: 'ho', basic: true },

            // M-row (basics)
            { char: '„Åæ', romaji: 'ma', basic: true },
            { char: '„Åø', romaji: 'mi', basic: true },
            { char: '„ÇÄ', romaji: 'mu', basic: true },
            { char: '„ÇÅ', romaji: 'me', basic: true },
            { char: '„ÇÇ', romaji: 'mo', basic: true },

            // Y-row (basics)
            { char: '„ÇÑ', romaji: 'ya', basic: true },
            { char: '„ÇÜ', romaji: 'yu', basic: true },
            { char: '„Çà', romaji: 'yo', basic: true },

            // R-row (basics)
            { char: '„Çâ', romaji: 'ra', basic: true },
            { char: '„Çä', romaji: 'ri', basic: true },
            { char: '„Çã', romaji: 'ru', basic: true },
            { char: '„Çå', romaji: 're', basic: true },
            { char: '„Çç', romaji: 'ro', basic: true },

            // W-row (basics)
            { char: '„Çè', romaji: 'wa', basic: true },
            { char: '„Çí', romaji: 'wo', basic: true },

            // N (basics)
            { char: '„Çì', romaji: 'n', basic: true },

            // G-row (dakuten)
            { char: '„Åå', romaji: 'ga', basic: false },
            { char: '„Åé', romaji: 'gi', basic: false },
            { char: '„Åê', romaji: 'gu', basic: false },
            { char: '„Åí', romaji: 'ge', basic: false },
            { char: '„Åî', romaji: 'go', basic: false },

            // Z-row (dakuten)
            { char: '„Åñ', romaji: 'za', basic: false },
            { char: '„Åò', romaji: 'ji', basic: false },
            { char: '„Åö', romaji: 'zu', basic: false },
            { char: '„Åú', romaji: 'ze', basic: false },
            { char: '„Åû', romaji: 'zo', basic: false },

            // D-row (dakuten)
            { char: '„Å†', romaji: 'da', basic: false },
            { char: '„Å¢', romaji: 'di', basic: false },
            { char: '„Å•', romaji: 'du', basic: false },
            { char: '„Åß', romaji: 'de', basic: false },
            { char: '„Å©', romaji: 'do', basic: false },

            // B-row (dakuten)
            { char: '„Å∞', romaji: 'ba', basic: false },
            { char: '„Å≥', romaji: 'bi', basic: false },
            { char: '„Å∂', romaji: 'bu', basic: false },
            { char: '„Åπ', romaji: 'be', basic: false },
            { char: '„Åº', romaji: 'bo', basic: false },

            // P-row (handakuten)
            { char: '„Å±', romaji: 'pa', basic: false },
            { char: '„Å¥', romaji: 'pi', basic: false },
            { char: '„Å∑', romaji: 'pu', basic: false },
            { char: '„Å∫', romaji: 'pe', basic: false },
            { char: '„ÅΩ', romaji: 'po', basic: false }
        ];

        // State
        let currentQuestion = null;
        let score = 0;
        let totalQuestions = 0;
        let streak = 0;
        let reverseMode = false;
        let enabledChars = new Set(hiraganaData.map(h => h.char));

        // Text-to-speech
        const synth = window.speechSynthesis;

        // DOM elements
        const soundDisplay = document.getElementById('soundDisplay');
        const optionsGrid = document.getElementById('optionsGrid');
        const feedback = document.getElementById('feedback');
        const nextBtn = document.getElementById('nextBtn');
        const progressFill = document.getElementById('progressFill');
        const scoreText = document.getElementById('scoreText');
        const streakText = document.getElementById('streakText');
        const questionText = document.getElementById('questionText');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeModal = document.getElementById('closeModal');
        const normalModeBtn = document.getElementById('normalModeBtn');
        const reverseModeBtn = document.getElementById('reverseModeBtn');
        const hiraganaGrid = document.getElementById('hiraganaGrid');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const basicsOnlyBtn = document.getElementById('basicsOnlyBtn');

        // Load settings from localStorage
        function loadSettings() {
            const savedMode = localStorage.getItem('reverseMode');
            if (savedMode !== null) {
                reverseMode = savedMode === 'true';
                updateModeButtons();
            }

            const savedChars = localStorage.getItem('enabledChars');
            if (savedChars) {
                enabledChars = new Set(JSON.parse(savedChars));
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('reverseMode', reverseMode);
            localStorage.setItem('enabledChars', JSON.stringify([...enabledChars]));
        }

        // Initialize hiragana grid with traditional chart layout
        function initHiraganaGrid() {
            hiraganaGrid.innerHTML = '';

            // Define the traditional chart structure
            const chart = {
                basic: {
                    title: 'Basic Hiragana (Ê∏ÖÈü≥)',
                    headers: ['W', 'R', 'Y', 'M', 'H', 'N', 'T', 'S', 'K', '‚Ä¢'],
                    vowels: ['A', 'I', 'U', 'E', 'O'],
                    grid: [
                        ['„Çè', '„Çâ', '„ÇÑ', '„Åæ', '„ÅØ', '„Å™', '„Åü', '„Åï', '„Åã', '„ÅÇ'],
                        ['',   '„Çä', '',   '„Åø', '„Å≤', '„Å´', '„Å°', '„Åó', '„Åç', '„ÅÑ'],
                        ['„Çì', '„Çã', '„ÇÜ', '„ÇÄ', '„Åµ', '„Å¨', '„Å§', '„Åô', '„Åè', '„ÅÜ'],
                        ['',   '„Çå', '',   '„ÇÅ', '„Å∏', '„Å≠', '„Å¶', '„Åõ', '„Åë', '„Åà'],
                        ['„Çí', '„Çç', '„Çà', '„ÇÇ', '„Åª', '„ÅÆ', '„Å®', '„Åù', '„Åì', '„Åä']
                    ]
                },
                dakuten: {
                    title: 'Dakuten (ÊøÅÈü≥)',
                    headers: ['', '', '', 'B', '', '', 'D', 'Z', 'G', ''],
                    vowels: ['A', 'I', 'U', 'E', 'O'],
                    grid: [
                        ['', '', '', '„Å∞', '', '', '„Å†', '„Åñ', '„Åå', ''],
                        ['', '', '', '„Å≥', '', '', '„Å¢', '„Åò', '„Åé', ''],
                        ['', '', '', '„Å∂', '', '', '„Å•', '„Åö', '„Åê', ''],
                        ['', '', '', '„Åπ', '', '', '„Åß', '„Åú', '„Åí', ''],
                        ['', '', '', '„Åº', '', '', '„Å©', '„Åû', '„Åî', '']
                    ]
                },
                handakuten: {
                    title: 'Handakuten (ÂçäÊøÅÈü≥)',
                    headers: ['', '', '', 'P', '', '', '', '', '', ''],
                    vowels: ['A', 'I', 'U', 'E', 'O'],
                    grid: [
                        ['', '', '', '„Å±', '', '', '', '', '', ''],
                        ['', '', '', '„Å¥', '', '', '', '', '', ''],
                        ['', '', '', '„Å∑', '', '', '', '', '', ''],
                        ['', '', '', '„Å∫', '', '', '', '', '', ''],
                        ['', '', '', '„ÅΩ', '', '', '', '', '', '']
                    ]
                }
            };

            // Create each chart section
            Object.values(chart).forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'chart-section';

                const title = document.createElement('h4');
                title.textContent = section.title;
                sectionDiv.appendChild(title);

                const table = document.createElement('div');
                table.className = 'chart-table';

                // Empty top-left corner
                const corner = document.createElement('div');
                corner.className = 'chart-header';
                table.appendChild(corner);

                // Column headers (consonants)
                section.headers.forEach(header => {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'chart-header';
                    headerDiv.textContent = header;
                    table.appendChild(headerDiv);
                });

                // Rows with vowel labels and characters
                section.grid.forEach((row, rowIndex) => {
                    // Vowel label
                    const vowelLabel = document.createElement('div');
                    vowelLabel.className = 'vowel-label';
                    vowelLabel.textContent = section.vowels[rowIndex];
                    table.appendChild(vowelLabel);

                    // Characters in the row
                    row.forEach(char => {
                        const btn = document.createElement('button');
                        btn.className = 'char-toggle';

                        if (char === '') {
                            btn.classList.add('empty');
                        } else {
                            btn.textContent = char;
                            btn.dataset.char = char;

                            if (enabledChars.has(char)) {
                                btn.classList.add('active');
                            } else {
                                btn.classList.add('inactive');
                            }

                            btn.onclick = () => toggleCharacter(char, btn);
                        }

                        table.appendChild(btn);
                    });
                });

                sectionDiv.appendChild(table);
                hiraganaGrid.appendChild(sectionDiv);
            });
        }

        // Toggle character
        function toggleCharacter(char, btn) {
            if (enabledChars.has(char)) {
                enabledChars.delete(char);
                btn.classList.remove('active');
                btn.classList.add('inactive');
            } else {
                enabledChars.add(char);
                btn.classList.remove('inactive');
                btn.classList.add('active');
            }
            saveSettings();

            // Ensure at least one character is enabled
            if (enabledChars.size === 0) {
                enabledChars.add(char);
                btn.classList.add('active');
                btn.classList.remove('inactive');
                alert('At least one character must be enabled!');
            }
        }

        // Control buttons
        selectAllBtn.onclick = () => {
            hiraganaData.forEach(item => enabledChars.add(item.char));
            initHiraganaGrid();
            saveSettings();
        };

        deselectAllBtn.onclick = () => {
            if (confirm('This will deselect all characters. Are you sure?')) {
                enabledChars.clear();
                hiraganaData.forEach(item => {
                    if (item.basic) enabledChars.add(item.char);
                });
                initHiraganaGrid();
                saveSettings();
            }
        };

        basicsOnlyBtn.onclick = () => {
            enabledChars.clear();
            hiraganaData.forEach(item => {
                if (item.basic) enabledChars.add(item.char);
            });
            initHiraganaGrid();
            saveSettings();
        };

        // Update mode buttons
        function updateModeButtons() {
            if (reverseMode) {
                normalModeBtn.classList.remove('active');
                reverseModeBtn.classList.add('active');
            } else {
                normalModeBtn.classList.add('active');
                reverseModeBtn.classList.remove('active');
            }
        }

        // Mode toggle
        normalModeBtn.onclick = () => {
            reverseMode = false;
            updateModeButtons();
            saveSettings();
        };

        reverseModeBtn.onclick = () => {
            reverseMode = true;
            updateModeButtons();
            saveSettings();
        };

        // Modal controls
        settingsBtn.onclick = () => {
            settingsModal.classList.add('show');
            initHiraganaGrid();
        };

        closeModal.onclick = () => {
            settingsModal.classList.remove('show');
        };

        settingsModal.onclick = (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('show');
            }
        };

        // Text-to-speech function
        function speak(text) {
            // Cancel any ongoing speech
            synth.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.8;
            utterance.pitch = 1;

            synth.speak(utterance);
        }

        // Click to hear sound
        soundDisplay.onclick = () => {
            if (currentQuestion) {
                speak(currentQuestion.correct.romaji);
            }
        };

        // Shuffle array helper
        function shuffle(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Get enabled characters
        function getEnabledChars() {
            return hiraganaData.filter(h => enabledChars.has(h.char));
        }

        // Generate new question
        function generateQuestion() {
            // Reset UI
            feedback.className = 'feedback';
            nextBtn.className = 'next-btn';

            const availableChars = getEnabledChars();
            if (availableChars.length === 0) {
                alert('Please enable at least one character in settings!');
                return;
            }

            // Pick random correct answer from enabled characters
            const correctAnswer = availableChars[Math.floor(Math.random() * availableChars.length)];

            // Pick 9 random wrong answers from enabled characters
            const wrongAnswers = shuffle(availableChars.filter(h => h.char !== correctAnswer.char)).slice(0, 9);

            // Combine and shuffle all options
            const allOptions = shuffle([correctAnswer, ...wrongAnswers]);

            currentQuestion = {
                correct: correctAnswer,
                options: allOptions
            };

            // Update question text and display based on mode
            if (reverseMode) {
                questionText.textContent = 'Select the sound for:';
                soundDisplay.textContent = correctAnswer.char;
                soundDisplay.className = 'sound-display hiragana';
                soundDisplay.title = 'Click to hear pronunciation';
            } else {
                questionText.textContent = 'Select the character for:';
                soundDisplay.textContent = correctAnswer.romaji;
                soundDisplay.className = 'sound-display romaji';
                soundDisplay.title = 'Click to hear pronunciation';
            }

            // Play sound automatically
            speak(correctAnswer.romaji);

            // Generate option buttons
            optionsGrid.innerHTML = '';
            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';

                if (reverseMode) {
                    btn.textContent = option.romaji;
                    btn.classList.add('romaji');
                } else {
                    btn.textContent = option.char;
                    btn.classList.add('hiragana');
                }

                btn.onclick = () => checkAnswer(option, btn);
                optionsGrid.appendChild(btn);
            });
        }

        // Check answer
        function checkAnswer(selected, btn) {
            totalQuestions++;

            // Disable all buttons
            const allBtns = optionsGrid.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.classList.add('disabled'));

            const isCorrect = selected.char === currentQuestion.correct.char;

            if (isCorrect) {
                // Correct answer
                btn.classList.add('correct');
                feedback.textContent = 'üéâ Correct! Great job!';
                feedback.className = 'feedback correct show';
                score++;
                streak++;

                // Play sound again
                speak(currentQuestion.correct.romaji);

                // Update progress
                progressFill.style.width = '100%';
            } else {
                // Wrong answer
                btn.classList.add('wrong');

                if (reverseMode) {
                    feedback.textContent = `‚ùå Not quite. ${currentQuestion.correct.char} is "${currentQuestion.correct.romaji}"`;
                } else {
                    feedback.textContent = `‚ùå Not quite. The correct answer is ${currentQuestion.correct.char} (${currentQuestion.correct.romaji})`;
                }

                feedback.className = 'feedback wrong show';
                streak = 0;

                // Highlight correct answer
                allBtns.forEach(b => {
                    const btnText = reverseMode ? currentQuestion.correct.romaji : currentQuestion.correct.char;
                    if (b.textContent.toLowerCase() === btnText.toLowerCase()) {
                        b.classList.add('correct');
                    }
                });

                // Play correct sound
                speak(currentQuestion.correct.romaji);

                // Update progress
                progressFill.style.width = '50%';
            }

            // Update stats
            scoreText.textContent = `Score: ${score}/${totalQuestions}`;
            streakText.textContent = `Streak: ${streak}`;

            // Show next button
            nextBtn.classList.add('show');

            // Reset progress after animation
            setTimeout(() => {
                progressFill.style.width = '0%';
            }, 1000);
        }

        // Next question handler
        nextBtn.onclick = () => {
            generateQuestion();
        };

        // Initialize
        loadSettings();
        generateQuestion();
    </script>
</body>
</html>
